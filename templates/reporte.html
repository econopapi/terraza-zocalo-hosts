{% extends "base.html" %}

{% block title %}Reporte - Equipo {{ equipo.id_equipo }}{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        margin-bottom: 20px;
        font-size: 14px;
    }
    .breadcrumb a {
        color: #4CAF50;
        text-decoration: none;
    }
    .breadcrumb a:hover {
        text-decoration: underline;
    }
    .fecha-selector {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap; /* allow wrap on medium screens */
    }
    .fecha-selector input {
        max-width: 200px;
    }
    .fecha-selector button {
        padding: 10px 20px;
        font-size: 14px;
    }
    .fecha-selector .btn-hoy {
        background: #2196F3;
    }
    .fecha-selector .btn-hoy:hover {
        background: #0b7dda;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    /* Compact stat cards: horizontal layout */
    .stat-card {
        background: white;
        padding: 16px; /* more compact */
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 5px solid #4CAF50;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .stat-card.personas { border-left-color: #2196F3; }
    .stat-card.confirmadas { border-left-color: #4CAF50; }
    .stat-card.no-confirmadas { border-left-color: #ff9800; }
    .stat-label {
        font-size: 13px;          /* slightly smaller */
        color: #666;
        margin-bottom: 0;         /* no vertical space */
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .stat-value {
        font-size: 26px;          /* more compact number */
        font-weight: bold;
        color: #333;
    }
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }
    .tab-btn {
        background: none;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #999;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }
    .tab-btn.active {
        color: #4CAF50;
        border-bottom-color: #4CAF50;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .host-row {
        padding: 15px;
        background: white;
        border-radius: 6px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: background 0.2s;
    }
    .host-row:hover {
        background: #f8f9fa;
    }
    .host-name {
        font-weight: 600;
        color: #333;
        flex: 1;
    }
    .host-stats {
        display: flex;
        gap: 20px;
        font-size: 14px;
    }
    .host-stat {
        text-align: center;
    }
    .host-stat-label {
        color: #999;
        font-size: 12px;
        margin-bottom: 5px;
    }
    .host-stat-value {
        font-weight: bold;
        color: #333;
        font-size: 18px;
    }
    /* Mobile/vertical screen: stack date controls */
    @media (max-width: 768px) {
        .fecha-selector {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }
        .fecha-selector input,
        .fecha-selector button {
            width: 100%;
        }
    }
    @media print {
        .no-print {
            display: none !important;
        }
        .tab-content {
            display: block !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb no-print">
    <a href="{{ url_for('equipo_form', equipo_id=equipo.id_equipo) }}">‚Üê Volver a Equipo {{ equipo.id_equipo }}</a>
</div>

<div class="header">
    <h1>üìä Reporte del D√≠a</h1>
    <p>Equipo {{ equipo.id_equipo }} - L√≠der: {{ equipo.lider_equipo }}</p>
    <!-- Bot√≥n PDF -->
    <div class="no-print" style="margin-top:10px;">
        <button onclick="downloadPDF()">‚¨áÔ∏è Descargar PDF</button>
    </div>
</div>

<div class="form-card no-print">
    <div class="fecha-selector">
        <label for="fecha-input">Selecciona una fecha:</label>
        <input type="date" id="fecha-input" value="{{ fecha_reporte }}">
        <button onclick="filtrarPorFecha()">üîç Filtrar</button>
        <button onclick="irAHoy()" class="btn-hoy">üìÖ Ir a Hoy</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card personas">
        <div class="stat-label">üë• Total de Personas</div>
        <div class="stat-value">{{ total_personas }}</div>
    </div>
    <div class="stat-card confirmadas">
        <div class="stat-label">‚úÖ Personas Confirmadas</div>
        <div class="stat-value">{{ personas_confirmadas }}</div>
    </div>
    <div class="stat-card no-confirmadas">
        <div class="stat-label">‚ùå Personas No Confirmadas</div>
        <div class="stat-value">{{ total_personas - personas_confirmadas }}</div>
    </div>
    <div class="stat-card personas">
        <div class="stat-label">üçΩÔ∏è Total de Mesas</div>
        <div class="stat-value">{{ total_hosteos }}</div>
    </div>
    <div class="stat-card confirmadas">
        <div class="stat-label">‚úÖ Mesas Confirmadas</div>
        <div class="stat-value">{{ confirmados }}</div>
    </div>
    <div class="stat-card no-confirmadas">
        <div class="stat-label">‚ùå Mesas No Confirmadas</div>
        <div class="stat-value">{{ no_confirmados }}</div>
    </div>
</div>

<div class="form-card">
    <div class="tabs no-print">
        <button class="tab-btn active" onclick="switchTab(event, 'equipo')">Por Equipo</button>
        <button class="tab-btn" onclick="switchTab(event, 'host')">Desglose por Host</button>
    </div>

    <div id="equipo" class="tab-content active">
        <h2>Resumen del Equipo</h2>
        {% if registros %}
        <table>
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Host</th>
                    <th>Personas</th>
                    <th>Mesero</th>
                    <th>Confirmado</th>
                </tr>
            </thead>
            <tbody>
                {% for registro in registros %}
                <tr>
                    <td>{{ registro.hora.strftime('%H:%M') }}</td>
                    <!-- Fallback si el host no existe -->
                    <td>{{ registro.host.nombre_host if registro.host else 'N/D' }}</td>
                    <td>{{ registro.numero_personas }}</td>
                    <!-- Fallback si el mesero no existe -->
                    <td>{{ registro.mesero.nombre_mesero if registro.mesero else 'N/D' }}</td>
                    <td>
                        <span class="{% if registro.confirmada %}confirmada{% else %}no-confirmada{% endif %}">
                            {% if registro.confirmada %}‚úÖ{% else %}‚ùå{% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: #999; padding: 20px;">No hay registros para esta fecha</p>
        {% endif %}
    </div>

    <div id="host" class="tab-content">
        <h2>Ranking de Hosts</h2>
        {% if ranking %}
        <div style="display: flex; flex-direction: column; gap: 10px;">
            {% for row in ranking %}
            <div class="host-row" onclick="irAReporteHost({{ row[1] }})">
                <div class="host-name">{{ row[0] }}</div>
                <div class="host-stats">
                    <div class="host-stat">
                        <div class="host-stat-label">Mesas</div>
                        <div class="host-stat-value">{{ row[2] }}</div>
                    </div>
                    <div class="host-stat">
                        <div class="host-stat-label">Personas</div>
                        <div class="host-stat-value">{{ row[3] or 0 }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: #999; padding: 20px;">No hay hosts con registros para esta fecha</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function switchTab(event, tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

function filtrarPorFecha() {
    const fecha = document.getElementById('fecha-input').value;
    const equipo_id = {{ equipo.id_equipo }};
    window.location.href = `/reporte/${equipo_id}?fecha=${fecha}`;
}

function irAHoy() {
    const today = new Date().toISOString().split('T')[0];
    const equipo_id = {{ equipo.id_equipo }};
    window.location.href = `/reporte/${equipo_id}?fecha=${today}`;
}

function irAReporteHost(host_id) {
    const fecha = document.getElementById('fecha-input').value;
    const equipo_id = {{ equipo.id_equipo }};
    window.location.href = `/reporte/${equipo_id}/host/${host_id}?fecha=${fecha}`;
}

function downloadPDF() {
    // Save current active tab
    const activeTab = document.querySelector('.tab-content.active');
    const activeId = activeTab ? activeTab.id : null;

    // Show all contents for print
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('active'));

    // After print, restore the original state
    const restore = () => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        const toActivate = document.getElementById(activeId || 'equipo');
        if (toActivate) toActivate.classList.add('active');
        window.removeEventListener('afterprint', restore);
    };

    window.addEventListener('afterprint', restore);
    window.print();
}
</script>
{% endblock %}
